<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒ¸ç—›ä¸­å¿ƒå…¨æµç¨‹è€ƒæ ¸ (æ™ºèƒ½éšæœºç‰ˆ v8.0)</title>
    <style>
        :root { --primary: #0056b3; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        
        /* ä¾§è¾¹æ  */
        .emr-sidebar { background: white; padding: 20px; border-radius: 8px; border-top: 5px solid var(--primary); height: fit-content; }
        .patient-header { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; float: right; border: 2px solid #ddd; }
        .log-list { font-size: 0.85em; color: #666; max-height: 400px; overflow-y: auto; }
        .log-entry { border-bottom: 1px dashed #eee; padding: 6px 0; }

        /* ä¸»èˆå° */
        .main-stage { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .scenario-box { background: #f8f9fa; padding: 20px; border-radius: 6px; border-left: 5px solid #17a2b8; margin: 20px 0; }
        
        /* å›¾ç‰‡åŒº */
        .media-box { text-align: center; margin: 15px 0; background: #000; padding: 10px; border-radius: 4px; display: none; }
        .media-img { max-width: 100%; max-height: 350px; border: 1px solid #444; }

        /* è¾“å…¥åŒº */
        .action-area textarea { width: 100%; height: 80px; padding: 10px; border: 2px solid #dfe3e6; border-radius: 4px; font-size: 1em; }
        button { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #004494; }
        .btn-next { background: #28a745; display: none; }

        /* åé¦ˆåŒº */
        .feedback-box { margin-top: 20px; padding: 15px; background: #e8f0fe; border-radius: 6px; display: none; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="emr-sidebar">
        <div class="patient-header">
            <img id="pAvatar" class="avatar" src="" alt="avatar">
            <h3 style="margin:0 0 5px 0;">ç”µå­ç—…å†</h3>
            <div id="pInfo" style="font-size:0.9em; line-height:1.5;"></div>
        </div>
        <div style="font-weight:bold; color:#0056b3; margin-bottom:10px;">ğŸ“„ è¯Šç–—æ—¥å¿—</div>
        <div id="logList" class="log-list"></div>
        <div style="margin-top:20px; font-weight:bold; color:#d9534f; font-size:1.2em;">å¾—åˆ†: <span id="scoreVal">0</span></div>
    </div>

    <div class="main-stage">
        <div style="color:#888; font-size:0.9em;">æµç¨‹èŠ‚ç‚¹: <span id="stepNum">1</span> / 8</div>
        <h2 id="stepTitle">...</h2>
        
        <div id="scenarioBox" class="scenario-box">...</div>

        <div id="mediaBox" class="media-box">
            <img id="mediaImg" class="media-img" src="">
            <div style="color:#0f0; font-family:monospace; margin-top:5px;">[PACS System Image]</div>
        </div>

        <div class="action-area">
            <label id="questionLabel" style="font-weight:bold; display:block; margin-bottom:8px;"></label>
            <textarea id="answerInput" placeholder="è¯·è¾“å…¥åŒ»å˜±..."></textarea>
            <button id="submitBtn" onclick="submitStep()">æäº¤åŒ»å˜±</button>
            <button id="nextBtn" class="btn-next" onclick="nextStep()">è¿›å…¥ä¸‹ä¸€ç¯èŠ‚ â¡</button>
        </div>

        <div id="feedbackArea" class="feedback-box"></div>
    </div>
</div>

<script>
    // --- 1. ç—…ä¾‹ç”Ÿæˆå·¥å‚ (Random Case Factory) ---
    const caseTemplates = [
        {
            type: "Anterior_STEMI", // å‰å£å¿ƒæ¢—
            name: "ç‹å»ºå›½", age: 58, gender: "ç”·",
            avatar: "https://ui-avatars.com/api/?name=Wang+JG&background=0D8ABC&color=fff",
            history: "é«˜è¡€å‹10å¹´ï¼Œå¸çƒŸå²ã€‚",
            vitals: { bp: "150/90", hr: "105" },
            ecgImg: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/Anterior_STEMI_on_ECG.png/800px-Anterior_STEMI_on_ECG.png",
            ecgDiagnosis: "å¹¿æ³›å‰å£å¿ƒè‚Œæ¢—æ­»",
            ecgKeywords: ["å‰å£", "V1", "V2", "V3", "æŠ¬é«˜"],
            nitroSafe: true, // å¯ä»¥ç”¨ç¡é…¸ç”˜æ²¹
            PCI_Strategy: "ç›´æ¥PCI"
        },
        {
            type: "Inferior_STEMI", // ä¸‹å£å¿ƒæ¢— (é™·é˜±é¢˜)
            name: "å¼ æ·‘èŠ¬", age: 65, gender: "å¥³",
            avatar: "https://ui-avatars.com/api/?name=Zhang+SF&background=d63384&color=fff",
            history: "ç³–å°¿ç—…5å¹´ã€‚",
            vitals: { bp: "95/60", hr: "55" }, // è¡€å‹åä½
            ecgImg: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/12_Lead_ECG_showing_Inferior_STEMI.jpg/800px-12_Lead_ECG_showing_Inferior_STEMI.jpg",
            ecgDiagnosis: "ä¸‹å£å¿ƒè‚Œæ¢—æ­»",
            ecgKeywords: ["ä¸‹å£", "II", "III", "aVF", "æŠ¬é«˜"],
            nitroSafe: false, // âŒ ç¦ç”¨ç¡é…¸ç”˜æ²¹ (å› ä¸ºæ¶‰åŠå³å®¤/ä½è¡€å‹)
            PCI_Strategy: "ç›´æ¥PCI"
        }
    ];

    let currentCase = {};
    let steps = []; // åŠ¨æ€ç”Ÿæˆçš„æ­¥éª¤æ•°ç»„
    let currentStepIdx = 0;
    let totalScore = 0;

    // --- 2. åˆå§‹åŒ–é€»è¾‘ ---
    function initGame() {
        // éšæœºæŠ½å–ä¸€ä¸ªç—…äºº
        const randIdx = Math.floor(Math.random() * caseTemplates.length);
        currentCase = caseTemplates[randIdx];

        // æ¸²æŸ“ä¾§è¾¹æ 
        document.getElementById('pAvatar').src = currentCase.avatar;
        document.getElementById('pInfo').innerHTML = `
            <strong>${currentCase.name}</strong> (${currentCase.gender}, ${currentCase.age}å²)<br>
            æ—¢å¾€å²: ${currentCase.history}
        `;

        // åŠ¨æ€æ„å»º 8 æ­¥å‰§æœ¬ (æ ¹æ®æŠ½å–åˆ°çš„ç—…äººå¡«ç©º)
        buildSteps();
        
        // æ¸²æŸ“ç¬¬ä¸€æ­¥
        renderStep();
        addLog(`æ‚£è€… ${currentCase.name} åˆ°è¾¾æ€¥è¯Šã€‚`);
    }

    function buildSteps() {
        // è¿™é‡Œæ˜¯æ ¹æ® randomCase åŠ¨æ€ç”Ÿæˆçš„å‰§æœ¬
        steps = [
            {
                title: "1. å¿«é€Ÿæ¥è¯Š",
                text: `æ‚£è€…ä¸»è¯‰èƒ¸éª¨åå‰§çƒˆç–¼ç—›2å°æ—¶ã€‚æŸ¥ä½“ï¼šBP ${currentCase.vitals.bp}, HR ${currentCase.vitals.hr}ã€‚ç¥å¿—æ¸…ã€‚`,
                question: "è¯·ä¸‹è¾¾ã€é»„é‡‘10åˆ†é’Ÿã€å†…å¿…é¡»å®Œæˆçš„é¦–è¦åŒ»å˜±ï¼š",
                keywords: ["å¿ƒç”µå›¾", "ECG", "å¸æ°§", "é€šé“"],
                media: null,
                feedback: "âœ… <strong>è§£æï¼š</strong> æ— è®ºä»€ä¹ˆç±»å‹çš„èƒ¸ç—›ï¼Œ10åˆ†é’Ÿå†…å®Œæˆå¿ƒç”µå›¾æ˜¯é“å¾‹ã€‚"
            },
            {
                title: "2. å¿ƒç”µå›¾åˆ¤è¯»",
                text: "æŠ¤å£«å·²å®Œæˆå¿ƒç”µå›¾ï¼ˆè§ä¸‹å›¾ï¼‰ã€‚",
                question: "è¯·ä»”ç»†è§‚å¯Ÿå¿ƒç”µå›¾ï¼Œå†™å‡ºæ‚¨çš„å®šä½è¯Šæ–­ï¼š",
                keywords: currentCase.ecgKeywords, // åŠ¨æ€å…³é”®è¯
                media: currentCase.ecgImg, // åŠ¨æ€å›¾ç‰‡
                feedback: `âœ… <strong>è§£æï¼š</strong> å›¾ä¸­å¯è§ ${currentCase.ecgKeywords.join('/')} å¯¼è”STæ®µæŠ¬é«˜ï¼Œè¯Šæ–­ä¸ºï¼š${currentCase.ecgDiagnosis}ã€‚`
            },
            {
                title: "3. è´Ÿè·ç»™è¯",
                text: `ç¡®è¯Šä¸º ${currentCase.ecgDiagnosis}ã€‚å‡†å¤‡è¡Œæ€¥è¯ŠPCIã€‚`,
                question: "è¯·ä¸‹è¾¾ã€åŒæŠ—ã€è´Ÿè·å‰‚é‡åŒ»å˜±ï¼š",
                keywords: ["é˜¿å¸åŒ¹æ—", "300", "æ›¿æ ¼ç‘æ´›", "180", "æ°¯å¡æ ¼é›·"],
                media: null,
                feedback: "âœ… <strong>è§£æï¼š</strong> è´Ÿè·é‡ï¼šé˜¿å¸åŒ¹æ—300mg + æ›¿æ ¼ç‘æ´›180mg (æˆ–æ°¯å¡æ ¼é›·300-600mg)ã€‚"
            },
            {
                title: "4. ç¦å¿Œç—‡æ’æŸ¥",
                text: "åœ¨ç»™è¯å‰ï¼Œé™¤äº†è¯¢é—®å‡ºè¡€å²ï¼Œè€ƒè™‘åˆ°æ‚£è€…èƒ¸ç—›å‰§çƒˆï¼Œè¿˜éœ€ç®€å•å¬è¯Šå¿ƒè„å¹¶æµ‹é‡åŒä¸Šè‚¢è¡€å‹ã€‚",
                question: "è¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ’é™¤å“ªç§è‡´æ­»æ€§ç–¾ç—…ï¼Ÿ",
                keywords: ["å¤¹å±‚", "æ’•è£‚", "ä¸»åŠ¨è„‰"],
                media: null,
                feedback: "âœ… <strong>è§£æï¼š</strong> å¿…é¡»æ’é™¤ä¸»åŠ¨è„‰å¤¹å±‚ï¼Œå¦åˆ™æŠ—æ “æ²»ç–—æ˜¯è‡´å‘½çš„ã€‚"
            },
            {
                title: "5. ç—‡çŠ¶æ§åˆ¶ (é™·é˜±é¢˜)",
                text: `æ‚£è€…ä»è¯‰èƒ¸ç—›ã€‚å½“å‰è¡€å‹ ${currentCase.vitals.bp}ã€‚`,
                question: "æ˜¯å¦ç»™äºˆç¡é…¸ç”˜æ²¹ï¼ˆå«æœæˆ–æ³µå…¥ï¼‰ï¼Ÿè¯·è¯´æ˜ç†ç”±ã€‚",
                keywords: [], // ç‰¹æ®Šé€»è¾‘åˆ¤æ–­
                media: null,
                // è¿™é‡Œ feedback åªæ˜¯é»˜è®¤å€¼ï¼Œå®é™…é€»è¾‘åœ¨ submitStep é‡ŒåŠ¨æ€åˆ¤æ–­
                feedback: "" 
            },
            {
                title: "6. å†çŒæ³¨ç­–ç•¥",
                text: "ç—‡çŠ¶ç¨ç¼“è§£ã€‚å¯¼ç®¡å®¤å·²æ¿€æ´»ã€‚é¢„è®¡ D2B < 60minã€‚",
                question: "é¦–é€‰æ²»ç–—ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ",
                keywords: ["PCI", "ä»‹å…¥", "é€ å½±"],
                media: null,
                feedback: "âœ… <strong>è§£æï¼š</strong> å¯¹äºæœ‰PCIèƒ½åŠ›çš„åŒ»é™¢ï¼Œé¦–é€‰ç›´æ¥PCIã€‚"
            },
            {
                title: "7. çŸ¥æƒ…åŒæ„",
                text: "å®¶å±å¯¹æ‰‹æœ¯æœ‰é¡¾è™‘ï¼Œè¿˜åœ¨æ‰“ç”µè¯å•†é‡ã€‚",
                question: "ä¸ºç¡®ä¿ D2B è¾¾æ ‡ï¼Œä½ è¯¥å¦‚ä½•æ²Ÿé€šï¼Ÿ",
                keywords: ["ç”Ÿå‘½", "æ—¶é—´", "åæ­»", "ç­¾å­—"],
                media: null,
                feedback: "âœ… <strong>è§£æï¼š</strong> å¼ºè°ƒç—…æƒ…å±é‡æ€§å’Œæ—¶é—´ç´§è¿«æ€§ï¼Œäº‰å–ç«‹å³ç­¾å­—ã€‚"
            },
            {
                title: "8. äºŒçº§é¢„é˜²",
                text: "æ‰‹æœ¯é¡ºåˆ©ï¼Œå®‰è¿”ç—…æˆ¿ã€‚",
                question: "å‡ºé™¢åéœ€é•¿æœŸæœç”¨å“ªäº›è¯ç‰©ï¼ˆåˆ—ä¸¾3ç±»ï¼‰ï¼Ÿ",
                keywords: ["ä»–æ±€", "Î²", "å€ä»–", "ACEI", "ARB", "åŒæŠ—"],
                media: null,
                feedback: "âœ… <strong>è§£æï¼š</strong> å† å¿ƒç—…äºŒçº§é¢„é˜² ABCDE æ–¹æ¡ˆã€‚"
            }
        ];
    }

    // --- 3. äº¤äº’é€»è¾‘ ---
    function renderStep() {
        const step = steps[currentStepIdx];
        document.getElementById('stepNum').innerText = currentStepIdx + 1;
        document.getElementById('stepTitle').innerText = step.title;
        document.getElementById('scenarioBox').innerHTML = step.text;
        document.getElementById('questionLabel').innerText = step.question;
        document.getElementById('answerInput').value = "";
        
        const mBox = document.getElementById('mediaBox');
        if (step.media) {
            document.getElementById('mediaImg').src = step.media;
            mBox.style.display = 'block';
        } else {
            mBox.style.display = 'none';
        }

        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
    }

    function submitStep() {
        const input = document.getElementById('answerInput').value;
        if(!input) { alert("è¯·è¾“å…¥åŒ»å˜±ï¼"); return; }
        
        const step = steps[currentStepIdx];
        const fbArea = document.getElementById('feedbackArea');
        let score = 0;
        let fbText = "";

        // ç‰¹æ®Šå¤„ç†ç¬¬ 5 æ­¥ (ç¡é…¸ç”˜æ²¹é™·é˜±)
        if (currentStepIdx === 4) {
            const hasNitro = ["ç¡é…¸ç”˜æ²¹", "æ¶ˆå¿ƒç—›", "ç¡é…¸é…¯"].some(k => input.includes(k));
            if (currentCase.nitroSafe) {
                // å‰å£å¿ƒæ¢—ï¼šå¯ä»¥ç”¨
                if (hasNitro) { score = 12.5; fbText = "âœ… æ­£ç¡®ã€‚è¡€å‹è€å—ï¼Œç»™äºˆç¡é…¸ç”˜æ²¹å¯ç¼“è§£ç¼ºè¡€ã€‚"; }
                else { score = 5; fbText = "âš ï¸ æ­¤æ—¶å¯ä»¥ç”¨ç¡é…¸ç”˜æ²¹ï¼Œä½ æœªæåŠã€‚"; }
            } else {
                // ä¸‹å£å¿ƒæ¢— (ä½è¡€å‹)ï¼šç»å¯¹ç¦ç”¨ï¼
                if (hasNitro) { score = 0; fbText = "âŒ <strong>é”™è¯¯ï¼</strong> ä¸‹å£å¿ƒæ¢—å¸¸åˆå¹¶å³å®¤æ¢—æ­»ï¼Œä¸”æ‚£è€…è¡€å‹åä½ï¼Œç¡é…¸ç”˜æ²¹ä¼šå¯¼è‡´ä¼‘å…‹ï¼"; }
                else { score = 12.5; fbText = "âœ… æ­£ç¡®ã€‚ä½ é¿å¼€äº†é™·é˜±ï¼æ‚£è€…ä½è¡€å‹/ä¸‹å£å¿ƒæ¢—ï¼Œç¦ç”¨ç¡é…¸ç”˜æ²¹ã€‚"; }
            }
        } else {
            // å¸¸è§„å…³é”®è¯åŒ¹é…
            const hit = step.keywords.some(k => input.toLowerCase().includes(k.toLowerCase()));
            if (hit) {
                score = 12.5;
                fbText = step.feedback;
            } else {
                fbText = "âŒ å…³é”®ç‚¹é—æ¼ã€‚<br>" + step.feedback;
            }
        }

        totalScore += score;
        document.getElementById('scoreVal').innerText = totalScore;
        
        fbArea.innerHTML = fbText;
        fbArea.style.display = 'block';
        addLog(`Step ${currentStepIdx+1}: å®Œæˆã€‚å¾—åˆ† ${score}`);

        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
    }

    function nextStep() {
        if (currentStepIdx < steps.length - 1) {
            currentStepIdx++;
            renderStep();
        } else {
            alert(`è€ƒæ ¸ç»“æŸï¼æœ€ç»ˆå¾—åˆ†ï¼š${totalScore}`);
            location.reload(); // åˆ·æ–°å¼€å§‹æ–°ç—…ä¾‹
        }
    }

    function addLog(msg) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerText = new Date().toLocaleTimeString('en-US', {hour12:false}) + " " + msg;
        document.getElementById('logList').prepend(div);
    }

    // å¯åŠ¨
    window.onload = initGame;
</script>

</body>
</html>